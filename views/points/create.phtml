<div class="mb-4">
    <a href="<?= $baseUrl ?>/children/<?= $child['id'] ?>" class="text-muted text-decoration-none">
        <i class="bi bi-arrow-left me-1"></i><?= $lang->t('back') ?>
    </a>
</div>

<div class="d-flex align-items-center gap-3 mb-5">
    <?php if ($child['photo_path']): ?>
        <img src="<?= $baseUrl ?>/<?= htmlspecialchars($child['photo_path']) ?>"
             class="rounded-circle"
             width="64" height="64"
             style="object-fit: cover; border: 3px solid var(--cream-dark);">
    <?php else: ?>
        <div class="rounded-circle d-flex align-items-center justify-content-center"
             style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--coral), var(--lavender)); color: #fff; font-size: 1.8rem;">
            <i class="bi bi-person-fill"></i>
        </div>
    <?php endif; ?>
    <div>
        <h2 class="mb-0"><?= $lang->t('add_points') ?></h2>
        <p class="text-muted mb-0"><?= htmlspecialchars($child['nickname'] ?? $child['name']) ?></p>
    </div>
</div>

<?php
$locale = $lang->getLocale();
$nameField = $locale === 'ka' ? 'name_ka' : 'name';
?>

<!-- Positive Behaviors -->
<div class="mb-5">
    <h5 class="d-flex align-items-center gap-2 mb-4">
        <span class="d-inline-flex align-items-center justify-content-center rounded-circle"
              style="width: 36px; height: 36px; background: var(--positive-bg);">
            <i class="bi bi-hand-thumbs-up-fill" style="color: var(--positive);"></i>
        </span>
        <?= $lang->t('positive') ?>
    </h5>
    <div class="row g-3">
        <?php foreach ($positive as $cat): ?>
        <div class="col-6 col-md-4 col-lg-3">
            <button type="button" class="category-btn positive w-100"
                    onclick="openPointModal(<?= $cat['id'] ?>, '<?= htmlspecialchars($cat[$nameField] ?? $cat['name'], ENT_QUOTES) ?>', '+<?= abs($cat['default_points']) ?>', 'positive')">
                <i class="bi <?= $cat['icon'] ?>"></i>
                <div class="fw-semibold"><?= htmlspecialchars($cat[$nameField] ?? $cat['name']) ?></div>
                <span class="points-badge">+<?= abs($cat['default_points']) ?></span>
            </button>
        </div>
        <?php endforeach; ?>
    </div>
</div>

<!-- Negative Behaviors -->
<div class="mb-5">
    <h5 class="d-flex align-items-center gap-2 mb-4">
        <span class="d-inline-flex align-items-center justify-content-center rounded-circle"
              style="width: 36px; height: 36px; background: var(--negative-bg);">
            <i class="bi bi-hand-thumbs-down-fill" style="color: var(--negative);"></i>
        </span>
        <?= $lang->t('negative') ?>
    </h5>
    <div class="row g-3">
        <?php foreach ($negative as $cat): ?>
        <div class="col-6 col-md-4 col-lg-3">
            <button type="button" class="category-btn negative w-100"
                    onclick="openPointModal(<?= $cat['id'] ?>, '<?= htmlspecialchars($cat[$nameField] ?? $cat['name'], ENT_QUOTES) ?>', '<?= $cat['default_points'] ?>', 'negative')">
                <i class="bi <?= $cat['icon'] ?>"></i>
                <div class="fw-semibold"><?= htmlspecialchars($cat[$nameField] ?? $cat['name']) ?></div>
                <span class="points-badge"><?= $cat['default_points'] ?></span>
            </button>
        </div>
        <?php endforeach; ?>
    </div>
</div>

<!-- Manual Adjustment -->
<div class="card" style="max-width: 500px;">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="bi bi-sliders me-2"></i><?= $lang->t('manual_adjustment') ?>
        </h6>
    </div>
    <div class="card-body">
        <form method="POST" action="<?= $baseUrl ?>/points">
            <input type="hidden" name="_csrf" value="<?= $csrfToken ?>">
            <input type="hidden" name="child_id" value="<?= $child['id'] ?>">
            <input type="hidden" name="redirect" value="/children/<?= $child['id'] ?>">

            <div class="mb-3">
                <label class="form-label"><?= $lang->t('points') ?></label>
                <input type="number" name="manual_points" class="form-control" placeholder="<?= $lang->t('points_placeholder') ?>" required>
                <small class="text-muted"><?= $lang->t('use_positive_negative') ?></small>
            </div>

            <div class="mb-3">
                <label class="form-label"><?= $lang->t('note') ?> <small class="text-muted">(<?= $lang->t('optional') ?>)</small></label>
                <textarea name="note" class="form-control" rows="2" placeholder="<?= $lang->t('optional_note') ?>"></textarea>
            </div>

            <div class="mb-4">
                <label class="form-label"><?= $lang->t('add_photo') ?> <small class="text-muted">(<?= $lang->t('optional') ?>)</small></label>
                <input type="file" class="form-control" accept="image/*" onchange="handleManualPhoto(this)">
                <input type="hidden" name="image" id="manualImageData">
                <div id="manualImagePreview" class="mt-2" style="display:none;">
                    <img src="" class="rounded" style="max-height: 100px;">
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearManualPhoto()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i><?= $lang->t('save') ?>
            </button>
        </form>
    </div>
</div>

<!-- Point Confirmation Modal -->
<div class="modal fade" id="pointModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pointModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="<?= $baseUrl ?>/points" id="pointModalForm">
                <input type="hidden" name="_csrf" value="<?= $csrfToken ?>">
                <input type="hidden" name="child_id" value="<?= $child['id'] ?>">
                <input type="hidden" name="category_id" id="modalCategoryId">
                <input type="hidden" name="redirect" value="/children/<?= $child['id'] ?>">
                <input type="hidden" name="image" id="modalImageData">
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <span class="badge fs-5" id="modalPointsBadge"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><?= $lang->t('note') ?> <small class="text-muted">(<?= $lang->t('optional') ?>)</small></label>
                        <textarea name="note" id="modalNote" class="form-control" rows="2" placeholder="<?= $lang->t('optional_note') ?>"></textarea>
                    </div>

                    <div class="mb-2">
                        <label class="form-label"><?= $lang->t('add_photo') ?> <small class="text-muted">(<?= $lang->t('optional') ?>)</small></label>
                        <input type="file" class="form-control" id="modalFileInput" accept="image/*">
                        <div id="modalImagePreview" class="mt-2" style="display:none;">
                            <img src="" class="rounded" style="max-height: 150px;">
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearModalPhoto()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i><?= $lang->t('close') ?>
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i><?= $lang->t('save') ?>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openPointModal(categoryId, categoryName, points, type) {
    document.getElementById('modalCategoryId').value = categoryId;
    document.getElementById('pointModalTitle').textContent = categoryName;
    const badge = document.getElementById('modalPointsBadge');
    badge.textContent = points;
    badge.className = 'badge fs-5 ' + (type === 'positive' ? 'bg-success' : 'bg-danger');

    // Reset form fields
    document.getElementById('modalNote').value = '';
    document.getElementById('modalImageData').value = '';
    document.getElementById('modalFileInput').value = '';
    document.getElementById('modalImagePreview').style.display = 'none';

    new bootstrap.Modal(document.getElementById('pointModal')).show();
}

var MAX_BYTES = 1 * 1024 * 1024; // 1 MB
var MIN_BYTES = 0.7 * 1024 * 1024; // 0.7 MB

function compressImage(file, callback) {
    var reader = new FileReader();
    reader.onload = function(e) {
        var dataUrl = e.target.result;
        // base64 portion is ~75% of data URL length; check raw size
        var rawBytes = Math.ceil((dataUrl.length - dataUrl.indexOf(',') - 1) * 3 / 4);
        if (rawBytes <= MAX_BYTES) {
            callback(dataUrl);
            return;
        }

        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var w = img.width, h = img.height;

            // Scale down large images to reduce pixel count first
            var maxDim = 1920;
            if (w > maxDim || h > maxDim) {
                var ratio = Math.min(maxDim / w, maxDim / h);
                w = Math.round(w * ratio);
                h = Math.round(h * ratio);
            }
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);

            // Binary search for the right JPEG quality
            var lo = 0.1, hi = 0.92, result = canvas.toDataURL('image/jpeg', lo);
            for (var i = 0; i < 10; i++) {
                var mid = (lo + hi) / 2;
                var attempt = canvas.toDataURL('image/jpeg', mid);
                var bytes = Math.ceil((attempt.length - attempt.indexOf(',') - 1) * 3 / 4);
                if (bytes > MAX_BYTES) {
                    hi = mid;
                } else if (bytes < MIN_BYTES) {
                    lo = mid;
                    result = attempt;
                } else {
                    result = attempt;
                    break;
                }
            }
            // If still over after search, use the lowest quality attempt
            var finalBytes = Math.ceil((result.length - result.indexOf(',') - 1) * 3 / 4);
            if (finalBytes > MAX_BYTES) {
                result = canvas.toDataURL('image/jpeg', 0.1);
            }
            callback(result);
        };
        img.src = dataUrl;
    };
    reader.readAsDataURL(file);
}

function setImagePreview(dataUrl, hiddenInput, previewContainer) {
    hiddenInput.value = dataUrl;
    previewContainer.querySelector('img').src = dataUrl;
    previewContainer.style.display = 'flex';
}

document.getElementById('modalFileInput').addEventListener('change', function() {
    var file = this.files[0];
    if (!file) return;
    compressImage(file, function(dataUrl) {
        setImagePreview(dataUrl, document.getElementById('modalImageData'), document.getElementById('modalImagePreview'));
    });
});

function clearModalPhoto() {
    document.getElementById('modalImageData').value = '';
    document.getElementById('modalFileInput').value = '';
    document.getElementById('modalImagePreview').style.display = 'none';
}

function handleManualPhoto(input) {
    var file = input.files[0];
    if (!file) return;
    compressImage(file, function(dataUrl) {
        setImagePreview(dataUrl, document.getElementById('manualImageData'), document.getElementById('manualImagePreview'));
    });
}

function clearManualPhoto() {
    document.getElementById('manualImageData').value = '';
    document.querySelector('.card .card-body input[type="file"]').value = '';
    document.getElementById('manualImagePreview').style.display = 'none';
}
</script>
