<?php
$locale = $lang->getLocale();
$nameField = $locale === 'ka' ? 'name_ka' : 'name';

// Note translation helper for chest/level-up/goal notes stored as English in DB
$_noteMap = [
    'Daily Chest' => $lang->t('chest_note_daily'),
    'Sunday Golden Chest' => $lang->t('chest_note_sunday'),
    'Bonus Chest Reward' => $lang->t('chest_note_bonus'),
];
$_levelRows = \App\Core\Database::getInstance()->query("SELECT name, name_ka FROM levels")->fetchAll();
$_levelMap = [];
foreach ($_levelRows as $_l) { $_levelMap[$_l['name']] = $_l['name_ka'] ?? $_l['name']; }
$_translateNote = function(?string $note) use ($_noteMap, $_levelMap, $locale, $lang): string {
    if (!$note) return '';
    if (isset($_noteMap[$note])) return $_noteMap[$note];
    if (isset($_levelMap[$note])) {
        $name = ($locale === 'ka' && !empty($_levelMap[$note])) ? $_levelMap[$note] : $note;
        return $lang->t('levelup_bonus_prefix') . ' ' . $name;
    }
    if (strpos($note, 'Goal Completion: ') === 0) {
        return $lang->t('goal_completion_prefix') . ' ' . substr($note, 17);
    }
    return $note;
};
?>
<div class="mb-4">
    <h2 class="mb-1"><?= $lang->t('transaction_history') ?></h2>
    <p class="text-muted mb-0"><?= $lang->t('history_desc') ?></p>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="<?= $baseUrl ?>/points/history" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label"><?= $lang->t('child') ?></label>
                <select name="child_id" class="form-select">
                    <option value=""><?= $lang->t('all') ?></option>
                    <?php foreach ($children as $c): ?>
                        <option value="<?= $c['id'] ?>" <?= ($filters['child_id'] ?? '') == $c['id'] ? 'selected' : '' ?>>
                            <?= htmlspecialchars($c['name']) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label"><?= $lang->t('category') ?></label>
                <select name="category_id" class="form-select">
                    <option value=""><?= $lang->t('all') ?></option>
                    <?php foreach ($categories as $c): ?>
                        <option value="<?= $c['id'] ?>" <?= ($filters['category_id'] ?? '') == $c['id'] ? 'selected' : '' ?>>
                            <?= htmlspecialchars($c[$nameField] ?? $c['name']) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label"><?= $lang->t('type') ?></label>
                <select name="type" class="form-select">
                    <option value=""><?= $lang->t('all') ?></option>
                    <option value="earn" <?= ($filters['type'] ?? '') === 'earn' ? 'selected' : '' ?>><?= $lang->t('earn') ?></option>
                    <option value="deduct" <?= ($filters['type'] ?? '') === 'deduct' ? 'selected' : '' ?>><?= $lang->t('deduct') ?></option>
                    <option value="redeem" <?= ($filters['type'] ?? '') === 'redeem' ? 'selected' : '' ?>><?= $lang->t('redeem') ?></option>
                    <option value="refund" <?= ($filters['type'] ?? '') === 'refund' ? 'selected' : '' ?>><?= $lang->t('refund') ?></option>
                    <option value="adjust" <?= ($filters['type'] ?? '') === 'adjust' ? 'selected' : '' ?>><?= $lang->t('adjust') ?></option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label"><?= $lang->t('date_from') ?></label>
                <input type="date" name="date_from" class="form-control" value="<?= $filters['date_from'] ?? '' ?>">
            </div>
            <div class="col-md-2">
                <label class="form-label"><?= $lang->t('date_to') ?></label>
                <input type="date" name="date_to" class="form-control" value="<?= $filters['date_to'] ?? '' ?>">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100">
                    <i class="bi bi-funnel me-1"></i><?= $lang->t('filter') ?>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-modern mb-0">
            <thead>
                <tr>
                    <th><?= $lang->t('date') ?></th>
                    <th><?= $lang->t('child') ?></th>
                    <th><?= $lang->t('category') ?></th>
                    <th><?= $lang->t('type') ?></th>
                    <th><?= $lang->t('points') ?></th>
                    <th><?= $lang->t('note') ?></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            <?php if (empty($transactions)): ?>
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mb-0 mt-2"><?= $lang->t('no_transactions') ?></p>
                    </td>
                </tr>
            <?php else: ?>
                <?php foreach ($transactions as $tx): ?>
                <tr>
                    <td>
                        <span><?= date('M j', strtotime($tx['transaction_date'])) ?></span>
                        <small class="d-block text-muted"><?= date('H:i', strtotime($tx['transaction_date'])) ?></small>
                    </td>
                    <td class="fw-semibold"><?= htmlspecialchars($tx['child_name']) ?></td>
                    <td>
                        <span class="d-inline-flex align-items-center" style="white-space:nowrap">
                            <?php if (!empty($tx['category_icon'])): ?>
                                <i class="bi <?= $tx['category_icon'] ?> me-1"></i>
                            <?php endif; ?>
                            <?= htmlspecialchars($locale === 'ka' && !empty($tx['category_name_ka']) ? $tx['category_name_ka'] : ($tx['category_name'] ?? '-')) ?>
                        </span>
                    </td>
                    <td><span class="badge badge-<?= $tx['type'] ?>"><?= $lang->t($tx['type']) ?></span></td>
                    <td>
                        <?php if (!empty($tx['multiplier_value']) && $tx['multiplier_value'] > 1): ?>
                            <div class="d-flex flex-column">
                                <span class="points-positive fw-bold">
                                    +<?= $tx['points'] ?>
                                </span>
                                <small class="text-warning">
                                    <i class="bi bi-lightning-charge-fill"></i>
                                    <?= $tx['multiplier_value'] ?>x
                                    <span class="text-success">(+<?= $tx['bonus_points'] ?>)</span>
                                </small>
                            </div>
                        <?php else: ?>
                            <span class="<?= $tx['points'] >= 0 ? 'points-positive' : 'points-negative' ?> fw-bold">
                                <?= ($tx['points'] >= 0 ? '+' : '') . $tx['points'] ?>
                            </span>
                        <?php endif; ?>
                    </td>
                    <td class="text-muted">
                        <?php
                        $displayNote = '';
                        // For redeem/refund, use translated reward name if available
                        if (($tx['type'] === 'redeem' || $tx['type'] === 'refund') && !empty($tx['reward_name'])) {
                            $displayNote = ($locale === 'ka' && !empty($tx['reward_name_ka'])) ? $tx['reward_name_ka'] : $tx['reward_name'];
                        } elseif (!empty($tx['note'])) {
                            $displayNote = $_translateNote($tx['note']);
                            // Handle old data - strip English prefixes
                            if ($tx['type'] === 'redeem' || $tx['type'] === 'refund') {
                                $displayNote = preg_replace('/^Redeemed:\s*/', '', $displayNote);
                                $displayNote = preg_replace('/^Refund:\s*/', '', $displayNote);
                                $displayNote = preg_replace('/\s*\(cancelled\)$/', '', $displayNote);
                            }
                        }
                        echo htmlspecialchars($displayNote);
                        ?>
                    </td>
                    <td>
                        <?php if (!in_array($tx['type'], ['redeem', 'refund'])): ?>
                            <form method="POST" action="<?= $baseUrl ?>/points/delete/<?= $tx['id'] ?>" class="d-inline" onsubmit="return confirm('<?= $lang->t('confirm_delete_transaction') ?>')">
                                <input type="hidden" name="_csrf" value="<?= $csrfToken ?>">
                                <input type="hidden" name="redirect" value="/points/history">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="<?= $lang->t('delete_transaction') ?>">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        <?php endif; ?>
                    </td>
                </tr>
                <?php endforeach; ?>
            <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<?php if ($totalPages > 1): ?>
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        <?php for ($i = 1; $i <= $totalPages; $i++): ?>
            <?php $qs = http_build_query(array_merge($filters, ['page' => $i])); ?>
            <li class="page-item <?= $i === $page ? 'active' : '' ?>">
                <a class="page-link" href="<?= $baseUrl ?>/points/history?<?= $qs ?>"><?= $i ?></a>
            </li>
        <?php endfor; ?>
    </ul>
</nav>
<?php endif; ?>
